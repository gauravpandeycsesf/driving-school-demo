<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Driving School Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- React & Babel via CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --bg: #020617;
      --card-bg: rgba(15, 23, 42, 0.92);
      --border-soft: rgba(148, 163, 184, 0.3);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --success: #22c55e;
      --danger: #ef4444;
      --warning: #eab308;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top left, #1d4ed8 0, #020617 40%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    #root {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 12px;
    }

    .shell {
      width: 100%;
      max-width: 1100px;
      min-height: 70vh;
      border-radius: 24px;
      background: linear-gradient(145deg, rgba(15,23,42,0.92), rgba(15,23,42,0.96));
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 24px 80px rgba(15,23,42,0.9);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .shell-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border-soft);
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(16px);
      background: linear-gradient(
        to right,
        rgba(15,23,42,0.92),
        rgba(15,23,42,0.7),
        rgba(37,99,235,0.15)
      );
    }

    .title-area h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .title-area span {
      font-size: 11px;
      color: var(--text-muted);
    }

    .user-chip {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .user-chip-name {
      font-size: 14px;
      font-weight: 500;
    }

    .role-badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .role-CANDIDATE {
      background: rgba(22,163,74,0.12);
      border-color: rgba(34,197,94,0.7);
      color: #bbf7d0;
    }

    .role-INSTRUCTOR {
      background: rgba(56,189,248,0.12);
      border-color: rgba(56,189,248,0.7);
      color: #a5f3fc;
    }

    .role-ADMIN {
      background: rgba(248,250,252,0.06);
      border-color: rgba(148,163,184,0.7);
      color: #e5e7eb;
    }

    .btn {
      border-radius: 999px;
      padding: 6px 14px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-main);
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.16s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-color: rgba(37,99,235,0.3);
      color: white;
      box-shadow: 0 10px 30px rgba(37,99,235,0.4);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(37,99,235,0.55);
    }

    .btn-ghost {
      border-color: rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.6);
    }

    .btn-ghost:hover {
      background: rgba(30,64,175,0.5);
      border-color: rgba(96,165,250,0.9);
    }

    .shell-body {
      flex: 1;
      padding: 20px 24px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow: auto;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 16px;
    }

    .card {
      border-radius: 18px;
      padding: 16px 16px 18px;
      background: radial-gradient(circle at top left, rgba(148,163,184,0.09), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(30,64,175,0.45), rgba(15,23,42,0.9) 70%);
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow: 0 18px 40px rgba(15,23,42,0.85);
    }

    .card h2, .card h3, .card h4 {
      margin-top: 0;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 14px;
    }

    .field {
      margin-bottom: 8px;
    }

    .field label {
      font-size: 12px;
      color: var(--text-muted);
      display: block;
      margin-bottom: 3px;
    }

    .field input,
    .field select,
    .field textarea {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.85);
      color: var(--text-main);
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
    }

    .field textarea {
      border-radius: 12px;
      resize: vertical;
      min-height: 80px;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: rgba(59,130,246,0.95);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.75);
    }

    .helper-text {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.8);
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
    }

    .pill-success .pill-dot { background: var(--success); }
    .pill-warning .pill-dot { background: var(--warning); }
    .pill-neutral .pill-dot { background: #64748b; }

    .pill-clickable {
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .pill-clickable:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(37,99,235,0.35);
      border-color: rgba(96,165,250,0.9);
    }

    .pill-active {
      box-shadow: 0 0 0 1px rgba(96,165,250,0.9);
      border-color: rgba(96,165,250,1);
      background: rgba(37,99,235,0.25);
    }

    .status-chip {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .status-BOOKED {
      background: rgba(37,99,235,0.15);
      color: #bfdbfe;
    }

    .status-COMPLETED {
      background: rgba(22,163,74,0.18);
      color: #bbf7d0;
    }

    .status-CANCELLED {
      background: rgba(248,113,113,0.15);
      color: #fecaca;
    }

    .table-wrap {
      border-radius: 15px;
      border: 1px solid rgba(148,163,184,0.5);
      overflow: hidden;
      background: rgba(15,23,42,0.9);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(30,41,59,0.9);
    }

    thead {
      background: radial-gradient(circle at top left, rgba(148,163,184,0.3), rgba(15,23,42,0.95));
      color: #e5e7eb;
    }

    tbody tr:nth-child(odd) { background: rgba(15,23,42,0.9); }
    tbody tr:nth-child(even) { background: rgba(15,23,42,0.85); }

    tbody tr:hover { background: rgba(30,64,175,0.4); }

    .empty-state {
      padding: 10px;
      font-size: 13px;
      color: var(--text-muted);
      text-align: center;
    }

    .login-shell {
      max-width: 420px;
      margin: 0 auto;
    }

    @media (max-width: 800px) {
      .shell {
        border-radius: 0;
        max-width: 100%;
      }
      .shell-body {
        padding: 16px;
      }
      .grid-2 {
        grid-template-columns: minmax(0, 1fr);
      }
      .shell-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .user-chip {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const API_URL = "/api";

    // ============ Auth Hook ============

    function useAuth() {
      const [user, setUser] = React.useState(null);
      const [token, setToken] = React.useState(null);

      React.useEffect(() => {
        const stored = localStorage.getItem("demoAuth");
        if (stored) {
          const data = JSON.parse(stored);
          setUser(data.user);
          setToken(data.token);
        }
      }, []);

      const login = async (email, password) => {
        const res = await fetch(`${API_URL}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });
        if (!res.ok) throw new Error("Invalid login");
        const data = await res.json();
        localStorage.setItem("demoAuth", JSON.stringify(data));
        setUser(data.user);
        setToken(data.token);
      };

      const logout = () => {
        localStorage.removeItem("demoAuth");
        setUser(null);
        setToken(null);
      };

      return { user, token, login, logout };
    }

    // ============ Login (no visible demo credentials) ============

    function Login({ onLogin }) {
      const [email, setEmail] = React.useState("");
      const [password, setPassword] = React.useState("");
      const [error, setError] = React.useState("");

      const handleSubmit = async e => {
        e.preventDefault();
        setError("");
        try {
          await onLogin(email, password);
        } catch {
          setError("Invalid email or password");
        }
      };

      return (
        <div className="shell login-shell">
          <div className="shell-header">
            <div className="title-area">
              <h1>Driving School</h1>
              <span>Role-based booking & invoicing demo</span>
            </div>
          </div>
          <div className="shell-body">
            <div className="card">
              <h2>Sign in</h2>
              <p className="card-subtitle">
                Enter your assigned credentials to access the portal.
              </p>

              <form onSubmit={handleSubmit}>
                <div className="field">
                  <label>Email</label>
                  <input
                    value={email}
                    onChange={e => setEmail(e.target.value)}
                    type="email"
                    placeholder="you@example.com"
                  />
                </div>
                <div className="field">
                  <label>Password</label>
                  <input
                    value={password}
                    onChange={e => setPassword(e.target.value)}
                    type="password"
                    placeholder="••••••••"
                  />
                </div>
                {error && (
                  <div className="helper-text" style={{ color: "#fecaca" }}>
                    {error}
                  </div>
                )}
                <div style={{ marginTop: 10 }}>
                  <button className="btn btn-primary" type="submit">
                    Sign in
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      );
    }

    // ============ Candidate Dashboard (with clickable snapshot) ============

    function CandidateDashboard({ token }) {
      const [instructors, setInstructors] = React.useState([]);
      const [lessons, setLessons] = React.useState([]);
      const [date, setDate] = React.useState("");
      const [instructorId, setInstructorId] = React.useState("");
      const [availability, setAvailability] = React.useState([]);
      const [statusFilter, setStatusFilter] = React.useState("ALL");

      const headers = {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token
      };

      React.useEffect(() => {
        fetch(`${API_URL}/instructors`, { headers })
          .then(r => r.json())
          .then(setInstructors);
        loadLessons();
      }, []);

      const loadLessons = () => {
        fetch(`${API_URL}/lessons`, { headers })
          .then(r => r.json())
          .then(setLessons);
      };

      const checkAvailability = () => {
        if (!date || !instructorId) return;
        fetch(`${API_URL}/availability?instructorId=${instructorId}&date=${date}`, {
          headers
        })
          .then(r => r.json())
          .then(data => setAvailability(data.availableSlots || []));
      };

      const bookSlot = async time => {
        const res = await fetch(`${API_URL}/lessons`, {
          method: "POST",
          headers,
          body: JSON.stringify({
            instructorId: parseInt(instructorId),
            date,
            time,
            lessonType: "Standard"
          })
        });
        if (!res.ok) {
          const err = await res.json();
          alert(err.error);
          return;
        }
        alert("Lesson booked!");
        setAvailability([]);
        loadLessons();
      };

      const bookedCount = lessons.filter(l => l.status === "BOOKED").length;
      const completedCount = lessons.filter(l => l.status === "COMPLETED").length;

      const filteredLessons = React.useMemo(() => {
        if (statusFilter === "BOOKED") {
          return lessons.filter(l => l.status === "BOOKED");
        }
        if (statusFilter === "COMPLETED") {
          return lessons.filter(l => l.status === "COMPLETED");
        }
        return lessons;
      }, [lessons, statusFilter]);

      return (
        <>
          <div className="grid-2">
            <div className="card">
              <h2>Book a lesson</h2>
              <p className="card-subtitle">
                Pick an instructor, choose a date and reserve a slot in their calendar.
              </p>
              <div className="field">
                <label>Instructor</label>
                <select
                  value={instructorId}
                  onChange={e => setInstructorId(e.target.value)}
                >
                  <option value="">Select instructor</option>
                  {instructors.map(i => (
                    <option key={i.id} value={i.id}>
                      {i.name}
                    </option>
                  ))}
                </select>
              </div>
              <div className="field">
                <label>Date</label>
                <input
                  type="date"
                  value={date}
                  onChange={e => setDate(e.target.value)}
                />
              </div>
              <div style={{ marginTop: 10, marginBottom: 8 }}>
                <button
                  className="btn btn-primary"
                  type="button"
                  onClick={checkAvailability}
                  disabled={!date || !instructorId}
                >
                  Check availability
                </button>
              </div>
              {availability.length > 0 ? (
                <>
                  <div className="helper-text">Available time slots:</div>
                  <div style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
                    {availability.map(t => (
                      <button
                        key={t}
                        type="button"
                        className="btn btn-ghost"
                        onClick={() => bookSlot(t)}
                      >
                        {t}
                      </button>
                    ))}
                  </div>
                </>
              ) : (
                <div className="helper-text">
                  Choose a date and instructor to see free slots.
                </div>
              )}
            </div>

            <div className="card">
              <h2>Progress snapshot</h2>
              <p className="card-subtitle">
                Click a pill to filter the lessons table below by status.
              </p>
              <div style={{ display: "flex", gap: 12, flexWrap: "wrap" }}>
                <div
                  className={
                    "pill pill-neutral pill-clickable" +
                    (statusFilter === "BOOKED" ? " pill-active" : "")
                  }
                  onClick={() =>
                    setStatusFilter(prev => (prev === "BOOKED" ? "ALL" : "BOOKED"))
                  }
                >
                  <span className="pill-dot"></span>
                  <span>Booked: {bookedCount}</span>
                </div>
                <div
                  className={
                    "pill pill-success pill-clickable" +
                    (statusFilter === "COMPLETED" ? " pill-active" : "")
                  }
                  onClick={() =>
                    setStatusFilter(prev =>
                      prev === "COMPLETED" ? "ALL" : "COMPLETED"
                    )
                  }
                >
                  <span className="pill-dot"></span>
                  <span>Completed: {completedCount}</span>
                </div>
              </div>
              <div className="helper-text" style={{ marginTop: 10 }}>
                Current filter:{" "}
                {statusFilter === "ALL"
                  ? "All lessons"
                  : statusFilter === "BOOKED"
                  ? "Booked lessons"
                  : "Completed lessons"}
              </div>
            </div>
          </div>

          <div className="card">
            <h3>My lessons</h3>
            <LessonTable lessons={filteredLessons} showCandidate={false} />
          </div>
        </>
      );
    }

    // ============ Instructor Dashboard ============

    function InstructorDashboard({ token }) {
      const [lessons, setLessons] = React.useState([]);
      const [selected, setSelected] = React.useState(null);
      const [rating, setRating] = React.useState(5);
      const [comments, setComments] = React.useState("");

      const headers = {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token
      };

      React.useEffect(() => {
        loadLessons();
      }, []);

      const loadLessons = () => {
        fetch(`${API_URL}/lessons`, { headers })
          .then(r => r.json())
          .then(setLessons);
      };

      const submitFeedback = async e => {
        e.preventDefault();
        const res = await fetch(`${API_URL}/lessons/${selected.id}/feedback`, {
          method: "POST",
          headers,
          body: JSON.stringify({ rating, comments })
        });
        if (!res.ok) {
          alert("Error saving feedback");
          return;
        }
        alert("Feedback saved & lesson completed");
        setSelected(null);
        setRating(5);
        setComments("");
        loadLessons();
      };

      return (
        <>
          <div className="grid-2">
            <div className="card">
              <h2>Today's schedule</h2>
              <p className="card-subtitle">
                See all upcoming bookings and open each one to add feedback.
              </p>
              <LessonTable
                lessons={lessons}
                showInstructor={false}
                onFeedback={setSelected}
              />
            </div>

            <div className="card">
              <h2>Lesson feedback</h2>
              <p className="card-subtitle">
                Select a lesson on the left to record your notes and rating.
              </p>
              {selected ? (
                <form onSubmit={submitFeedback}>
                  <div className="helper-text">
                    Lesson #{selected.id} – {selected.date} at {selected.time} with{" "}
                    {selected.candidateName}
                  </div>
                  <div className="field">
                    <label>Rating (1–5)</label>
                    <input
                      type="number"
                      min="1"
                      max="5"
                      value={rating}
                      onChange={e => setRating(e.target.value)}
                    />
                  </div>
                  <div className="field">
                    <label>Comments</label>
                    <textarea
                      value={comments}
                      onChange={e => setComments(e.target.value)}
                      placeholder="Notes on driving skills, focus for next session…"
                    />
                  </div>
                  <button className="btn btn-primary" type="submit">
                    Save feedback
                  </button>
                </form>
              ) : (
                <div className="helper-text">
                  Select a lesson in the schedule table to start.
                </div>
              )}
            </div>
          </div>
        </>
      );
    }

    // ============ Admin Dashboard ============

    function AdminDashboard({ token }) {
      const [lessons, setLessons] = React.useState([]);
      const [invoices, setInvoices] = React.useState([]);
      const [candidateId, setCandidateId] = React.useState("");

      const headers = {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token
      };

      React.useEffect(() => {
        loadLessons();
        loadInvoices();
      }, []);

      const loadLessons = () => {
        fetch(`${API_URL}/lessons`, { headers })
          .then(r => r.json())
          .then(setLessons);
      };

      const loadInvoices = () => {
        fetch(`${API_URL}/invoices`, { headers })
          .then(r => r.json())
          .then(setInvoices);
      };

      const uniqueCandidates = Array.from(
        new Map(
          lessons.map(l => [l.candidateId, { id: l.candidateId, name: l.candidateName }])
        ).values()
      );

      const generateInvoice = async () => {
        const res = await fetch(`${API_URL}/invoices/generate`, {
          method: "POST",
          headers,
          body: JSON.stringify({ candidateId: parseInt(candidateId) })
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.error);
          return;
        }
        alert("Invoice generated");
        setCandidateId("");
        loadLessons();
        loadInvoices();
      };

      return (
        <>
          <div className="grid-2">
            <div className="card">
              <h2>Lesson overview</h2>
              <p className="card-subtitle">
                Monitor instructor utilisation and which lessons are ready for invoicing.
              </p>
              <LessonTable lessons={lessons} />
            </div>
            <div className="card">
              <h2>Billing & invoices</h2>
              <p className="card-subtitle">
                Select a candidate to generate invoices from completed lessons.
              </p>

              <div className="field">
                <label>Candidate</label>
                <select
                  value={candidateId}
                  onChange={e => setCandidateId(e.target.value)}
                >
                  <option value="">Select candidate</option>
                  {uniqueCandidates.map(c => (
                    <option key={c.id} value={c.id}>
                      {c.name}
                    </option>
                  ))}
                </select>
              </div>
              <button
                className="btn btn-primary"
                type="button"
                disabled={!candidateId}
                onClick={generateInvoice}
              >
                Generate invoice
              </button>

              <div style={{ marginTop: 20 }} className="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Number</th>
                      <th>Candidate</th>
                      <th>Total</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {invoices.length === 0 && (
                      <tr>
                        <td colSpan="5" className="empty-state">
                          No invoices yet.
                        </td>
                      </tr>
                    )}
                    {invoices.map(inv => (
                      <tr key={inv.id}>
                        <td>{inv.id}</td>
                        <td>{inv.invoiceNumber}</td>
                        <td>{inv.candidateName}</td>
                        <td>{inv.totalAmount}</td>
                        <td>{inv.status}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </>
      );
    }

    // ============ Reusable Lesson Table ============

    function LessonTable({ lessons, showCandidate = true, showInstructor = true, onFeedback }) {
      if (!lessons.length) {
        return <div className="empty-state">No lessons to display.</div>;
      }

      return (
        <div className="table-wrap">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                {showCandidate && <th>Candidate</th>}
                {showInstructor && <th>Instructor</th>}
                <th>Date</th>
                <th>Time</th>
                <th>Status</th>
                <th>Price</th>
                {onFeedback && <th></th>}
              </tr>
            </thead>
            <tbody>
              {lessons.map(l => (
                <tr key={l.id}>
                  <td>{l.id}</td>
                  {showCandidate && <td>{l.candidateName}</td>}
                  {showInstructor && <td>{l.instructorName}</td>}
                  <td>{l.date}</td>
                  <td>{l.time}</td>
                  <td>
                    <span className={`status-chip status-${l.status}`}>
                      {l.status}
                    </span>
                  </td>
                  <td>{l.price}</td>
                  {onFeedback && (
                    <td>
                      <button
                        type="button"
                        className="btn btn-ghost"
                        onClick={() => onFeedback(l)}
                      >
                        Feedback
                      </button>
                    </td>
                  )}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    // ============ Main App ============

    function App() {
      const { user, token, login, logout } = useAuth();

      if (!user) {
        return <Login onLogin={login} />;
      }

      return (
        <div className="shell">
          <div className="shell-header">
            <div className="title-area">
              <h1>Driving School</h1>
              <span>Scheduling • Feedback • Invoicing</span>
            </div>
            <div className="user-chip">
              <div className="user-chip-name">{user.name}</div>
              <div className={`role-badge role-${user.role}`}>
                {user.role.toLowerCase()}
              </div>
              <button className="btn btn-ghost" onClick={logout}>
                Logout
              </button>
            </div>
          </div>
          <div className="shell-body">
            {user.role === "CANDIDATE" && <CandidateDashboard token={token} />}
            {user.role === "INSTRUCTOR" && <InstructorDashboard token={token} />}
            {user.role === "ADMIN" && <AdminDashboard token={token} />}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
